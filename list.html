<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Facilita 2.0 - Lista de Casos">
  <meta name="keywords" content="facilita, angola, serviços públicos, casos">
  <meta name="author" content="Facilita Team">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- AOS Animation Library -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React and ReactDOM -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <title>Facilita 2.0 | Lista de Casos</title>
  <style>
    :root {
      --primary-color: #3b82f6;
      --primary-dark: #2563eb;
      --dark-bg: #0f172a;
      --light-text: #f3f4f6;
      --accent-color: #10b981;
      --danger-color: #ef4444;
      --warning-color: #f59e0b;
      --info-color: #0ea5e9;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--dark-bg);
      color: var(--light-text);
      margin: 0;
      overflow-x: hidden;
    }
    
    .navbar {
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(20px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      padding: 0.75rem 1.5rem;
      transition: all 0.3s ease;
      z-index: 1000;
      border-bottom: 2px solid var(--primary-color);
    }
    
    .navbar.scrolled {
      padding: 0.5rem 1.5rem;
    }
    
    .navbar-brand {
      display: flex;
      align-items: center;
      font-weight: 700;
      font-size: 1.5rem;
      color: white;
      text-shadow: 0 0 10px rgba(59, 130, 246, 0.7);
    }
    
    .logo {
      width: 36px;
      height: 36px;
      margin-right: 10px;
      filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.5));
      transition: transform 0.3s ease;
    }
    
    .navbar-brand:hover .logo {
      transform: rotate(15deg) scale(1.1);
    }
    
    .nav-link {
      font-weight: 500;
      color: white !important;
      position: relative;
      margin: 0 0.4rem;
      padding: 0.4rem 0.8rem !important;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }
    
    .nav-link::after {
      content: '';
      position: absolute;
      width: 0;
      height: 2px;
      bottom: 0;
      left: 50%;
      background-color: var(--primary-color);
      transition: all 0.3s ease;
    }
    
    .nav-link:hover::after {
      width: 80%;
      left: 10%;
    }
    
    .dropdown-menu {
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(59, 130, 246, 0.2);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }
    
    .dropdown-item {
      color: var(--light-text);
      font-size: 0.85rem;
      transition: all 0.3s ease;
    }
    
    .dropdown-item:hover {
      background: var(--primary-color);
      color: white;
    }
    
    .error-message {
      color: var(--danger-color);
      font-size: 0.9rem;
      text-align: center;
      padding: 1.5rem;
      background: rgba(255, 75, 75, 0.1);
      border-radius: 8px;
      margin: 0.75rem;
      border: 1px solid rgba(255, 75, 75, 0.3);
      box-shadow: 0 4px 10px rgba(255, 75, 75, 0.1);
    }
    
    .spinner {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .navbar {
        padding: 0.5rem 1rem;
      }
      
      .navbar-brand {
        font-size: 1.25rem;
      }
      
      .logo {
        width: 30px;
        height: 30px;
      }
      
      .nav-link {
        font-size: 0.8rem;
        padding: 0.3rem 0.6rem !important;
      }
    }
    
    @media (max-width: 992px) {
      .navbar-collapse {
        background: rgba(15, 23, 42, 0.98);
        border-radius: 0 0 10px 10px;
        padding: 0.75rem;
        margin-top: 0.3rem;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <img src="icons/Icon-192.png" alt="Logo Facilita" class="logo">
        Facilita 2.0
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="report.html">Mapa de Problemas</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="list.html">Lista</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Perfil
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
              <li><a class="dropdown-item" href="profile.html">Ver Perfil</a></li>
              <li><a class="dropdown-item" href="#" id="logoutLink">Sair</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div id="root" class="min-h-screen pt-16"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <!-- AOS Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>

  <!-- Firebase Auth Module -->
  <script src="js/firebaseAuth.js"></script>

  <script type="text/babel">
    // Initialize AOS
    AOS.init({ duration: 800, easing: 'ease-in-out', once: true });

    // Navbar scroll effect
    window.addEventListener('scroll', () => {
      const navbar = document.querySelector('.navbar');
      navbar.classList.toggle('scrolled', window.scrollY > 50);
    });

    // Utility functions
    const formatTimeAgo = (timestamp) => {
      const now = new Date();
      const date = new Date(timestamp);
      const diff = (now - date) / 1000; // seconds
      if (diff < 60) return 'Agora mesmo';
      if (diff < 3600) return `${Math.floor(diff / 60)} ${diff < 120 ? 'minuto' : 'minutos'}`;
      if (diff < 86400) return `${Math.floor(diff / 3600)} ${diff < 7200 ? 'hora' : 'horas'}`;
      if (diff < 2592000) return `${Math.floor(diff / 86400)} ${diff < 172800 ? 'dia' : 'dias'}`;
      return `${Math.floor(diff / 2592000)} ${diff < 5184000 ? 'mês' : 'meses'}`;
    };

    const calculateDistance = (userLocation, problem) => {
      if (!userLocation) return Infinity;
      const R = 6371; // Earth's radius in km
      const lat1 = userLocation.latitude * Math.PI / 180;
      const lat2 = (problem.location?.latitude || 0) * Math.PI / 180;
      const lon1 = userLocation.longitude * Math.PI / 180;
      const lon2 = (problem.location?.longitude || 0) * Math.PI / 180;
      const dLat = lat2 - lat1;
      const dLon = lon2 - lon1;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1) * Math.cos(lat2) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c; // Distance in km
    };

    // React Components
    const AppBar = ({ showSearch, setShowSearch, searchTerm, setSearchTerm, toggleFilters }) => {
      return (
        <div className="bg-indigo-900 text-white p-4 flex items-center justify-between">
          {showSearch ? (
            <div className="flex-1 flex items-center">
              <input
                type="text"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                placeholder="Pesquisar casos..."
                className="w-full bg-transparent border-none text-white placeholder-white placeholder-opacity-70 focus:outline-none"
                autoFocus
              />
              <button onClick={() => { setShowSearch(false); setSearchTerm(''); }}>
                <i className="fas fa-times text-white"></i>
              </button>
            </div>
          ) : (
            <>
              <button onClick={() => window.history.back()}>
                <i className="fas fa-arrow-left text-white mr-4"></i>
              </button>
              <h1 className="text-lg font-semibold flex-1">Casos Reportados</h1>
              <div className="flex space-x-2">
                <button onClick={() => setShowSearch(true)}>
                  <i className="fas fa-search text-white"></i>
                </button>
                <button onClick={toggleFilters}>
                  <i className="fas fa-filter text-white"></i>
                </button>
              </div>
            </>
          )}
        </div>
      );
    };

    const FilterPanel = ({
      maxDistance,
      setMaxDistance,
      selectedStatuses,
      toggleStatus,
      selectedCategories,
      toggleCategory,
      selectedUrgencies,
      toggleUrgency,
      clearFilters
    }) => {
      const statuses = ['Aguardando', 'Em andamento', 'Resolvido'];
      const categories = ['Buraco', 'Lixo', 'Iluminação', 'Água', 'Segurança'];
      const urgencies = ['Baixa', 'Média', 'Alta'];

      return (
        <div className="bg-white text-gray-900 p-4 shadow-md">
          <div className="flex justify-between items-center mb-2">
            <h2 className="text-sm font-bold">Filtros</h2>
            <button onClick={clearFilters} className="text-blue-500 text-sm">Limpar</button>
          </div>
          <div className="mb-2">
            <h3 className="text-xs font-semibold mb-1">Status</h3>
            <div className="flex flex-wrap gap-2">
              {statuses.map(status => (
                <button
                  key={status}
                  onClick={() => toggleStatus(status)}
                  className={`px-3 py-1 rounded-full text-xs border ${selectedStatuses.includes(status) ? 'bg-blue-100 border-blue-500 text-blue-500' : 'bg-gray-100 border-gray-300'}`}
                >
                  {status}
                </button>
              ))}
            </div>
          </div>
          <div className="mb-2">
            <h3 className="text-xs font-semibold mb-1">Categoria</h3>
            <div className="flex flex-wrap gap-2">
              {categories.map(category => (
                <button
                  key={category}
                  onClick={() => toggleCategory(category)}
                  className={`px-3 py-1 rounded-full text-xs border ${selectedCategories.includes(category) ? 'bg-blue-100 border-blue-500 text-blue-500' : 'bg-gray-100 border-gray-300'}`}
                >
                  {category}
                </button>
              ))}
            </div>
          </div>
          <div className="mb-2">
            <h3 className="text-xs font-semibold mb-1">Urgência</h3>
            <div className="flex flex-wrap gap-2">
              {urgencies.map(urgency => (
                <button
                  key={urgency}
                  onClick={() => toggleUrgency(urgency)}
                  className={`px-3 py-1 rounded-full text-xs border ${selectedUrgencies.includes(urgency) ? 'bg-blue-100 border-blue-500 text-blue-500' : 'bg-gray-100 border-gray-300'}`}
                >
                  {urgency}
                </button>
              ))}
            </div>
          </div>
          <div>
            <h3 className="text-xs font-semibold mb-1">Distância (km)</h3>
            <input
              type="range"
              min="1"
              max="100"
              value={maxDistance === Infinity ? 100 : maxDistance}
              onChange={(e) => setMaxDistance(e.target.value >= 100 ? Infinity : Number(e.target.value))}
              className="w-full"
            />
            <span className="text-xs">{maxDistance === Infinity ? 'Sem limite' : `${Math.round(maxDistance)} km`}</span>
          </div>
        </div>
      );
    };

    const ProblemCard = ({ problem, userLocation }) => {
      const distance = calculateDistance(userLocation, problem);
      const statusColor = {
        'Aguardando': 'blue-500',
        'Em andamento': 'orange-500',
        'Resolvido': 'green-500'
      }[problem.status] || 'gray-500';

      return (
        <div
          className="bg-gray-800 rounded-lg shadow-md p-4 mb-4 flex cursor-pointer hover:bg-gray-700 transition"
          onClick={() => alert('Detalhes do problema: ' + problem.title)} // Placeholder for navigation
          data-aos="fade-up"
        >
          <div className="w-20 h-20 rounded-lg overflow-hidden bg-gray-200 flex-shrink-0">
            {problem.imageUrl ? (
              <img src={problem.imageUrl} alt="Problema" className="w-full h-full object-cover" onError={(e) => e.target.outerHTML = '<i class="fas fa-broken-image text-gray-500 h-full flex items-center justify-center"></i>'} />
            ) : (
              <i className="fas fa-camera text-gray-500 h-full flex items-center justify-center"></i>
            )}
          </div>
          <div className="ml-4 flex-1">
            <span className={`inline-block px-2 py-1 rounded-full text-xs font-semibold bg-${statusColor}/20 text-${statusColor}`}>
              {problem.status.toUpperCase()}
            </span>
            <h3 className="text-sm font-semibold mt-2">{problem.title}</h3>
            <p className="text-xs text-gray-400">{problem.neighborhood || 'Local não especificado'}</p>
            <p className="text-xs text-gray-300 mt-1 line-clamp-2">{problem.description}</p>
            <div className="flex justify-between mt-2 text-xs text-gray-400">
              <span><i className="fas fa-clock mr-1"></i>{formatTimeAgo(problem.createdAt)}</span>
              <span><i className="fas fa-map-marker-alt mr-1"></i>{distance === Infinity ? 'Distância desconhecida' : `${distance.toFixed(1)} km`}</span>
            </div>
          </div>
        </div>
      );
    };

    const EmptyView = () => (
      <div className="flex flex-col items-center justify-center h-full text-gray-400">
        <i className="fas fa-file-alt text-6xl mb-4"></i>
        <h2 className="text-lg font-semibold">Nenhum caso encontrado</h2>
        <p className="text-sm text-center">Quando novos casos forem reportados, eles aparecerão aqui.</p>
      </div>
    );

    const EmptyFilterView = ({ clearFilters }) => (
      <div className="flex flex-col items-center justify-center h-full text-gray-400">
        <i className="fas fa-filter text-6xl mb-4"></i>
        <h2 className="text-lg font-semibold">Nenhum caso com esses filtros</h2>
        <button onClick={clearFilters} className="mt-2 text-blue-500">Limpar filtros</button>
      </div>
    );

    const ErrorView = ({ retry }) => (
      <div className="flex flex-col items-center justify-center h-full text-red-400">
        <i className="fas fa-exclamation-circle text-6xl mb-4"></i>
        <h2 className="text-lg font-semibold">Ocorreu um erro</h2>
        <button onClick={retry} className="mt-2 px-4 py-2 bg-blue-500 text-white rounded">Tentar novamente</button>
      </div>
    );

    const CasosScreen = () => {
      const [user, setUser] = React.useState(null);
      const [problems, setProblems] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      const [error, setError] = React.useState(null);
      const [userLocation, setUserLocation] = React.useState(null);
      const [showFilters, setShowFilters] = React.useState(false);
      const [showSearch, setShowSearch] = React.useState(false);
      const [searchTerm, setSearchTerm] = React.useState('');
      const [selectedStatuses, setSelectedStatuses] = React.useState([]);
      const [selectedCategories, setSelectedCategories] = React.useState([]);
      const [selectedUrgencies, setSelectedUrgencies] = React.useState([]);
      const [maxDistance, setMaxDistance] = React.useState(Infinity);

      React.useEffect(() => {
        // Initialize Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyDVtY6ML3j-qrIsAprIJPB5xFFCbcf4UQw",
          authDomain: "facilita-479b3.firebaseapp.com",
          databaseURL: "https://facilita-479b3-default-rtdb.firebaseio.com",
          projectId: "facilita-479b3",
          storageBucket: "facilita-479b3.appspot.com",
          messagingSenderId: "385676676886",
          appId: "1:385676676886:web:6976de7f3abc6c0da94a37"
        };
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }

        // Check authentication
        firebase.auth().onAuthStateChanged((u) => {
          if (!u) {
            window.location.href = 'login.html';
          } else {
            setUser(u);
          }
        });

        // Get user location
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => setUserLocation({ latitude: position.coords.latitude, longitude: position.coords.longitude }),
            (err) => console.error('Location error:', err)
          );
        }

        // Load problems
        const problemsRef = firebase.database().ref('problems');
        problemsRef.on('value', (snapshot) => {
          const data = snapshot.val();
          const problemList = data ? Object.entries(data).map(([id, p]) => ({ id, ...p })) : [];
          setProblems(problemList);
          setLoading(false);
        }, (err) => {
          setError(err.message);
          setLoading(false);
        });

        return () => problemsRef.off();
      }, []);

      const toggleStatus = (status) => {
        setSelectedStatuses(prev => prev.includes(status) ? prev.filter(s => s !== status) : [...prev, status]);
      };

      const toggleCategory = (category) => {
        setSelectedCategories(prev => prev.includes(category) ? prev.filter(c => c !== category) : [...prev, category]);
      };

      const toggleUrgency = (urgency) => {
        setSelectedUrgencies(prev => prev.includes(urgency) ? prev.filter(u => u !== urgency) : [...prev, urgency]);
      };

      const clearFilters = () => {
        setSelectedStatuses([]);
        setSelectedCategories([]);
        setSelectedUrgencies([]);
        setMaxDistance(Infinity);
      };

      const filteredProblems = problems
        .filter(p => {
          const searchLower = searchTerm.toLowerCase();
          const matchesSearch = !searchTerm ||
            p.title.toLowerCase().includes(searchLower) ||
            p.description.toLowerCase().includes(searchLower) ||
            (p.neighborhood || '').toLowerCase().includes(searchLower);
          const matchesDistance = calculateDistance(userLocation, p) <= maxDistance;
          const matchesStatus = !selectedStatuses.length || selectedStatuses.includes(p.status);
          const matchesCategory = !selectedCategories.length || selectedCategories.includes(p.category);
          const matchesUrgency = !selectedUrgencies.length || selectedUrgencies.includes(p.urgency);
          return matchesSearch && matchesDistance && matchesStatus && matchesCategory && matchesUrgency;
        })
        .sort((a, b) => b.createdAt - a.createdAt);

      return (
        <div className="px-4 pb-4">
          <AppBar
            showSearch={showSearch}
            setShowSearch={setShowSearch}
            searchTerm={searchTerm}
            setSearchTerm={setSearchTerm}
            toggleFilters={() => setShowFilters(!showFilters)}
          />
          {loading ? (
            <div className="flex justify-center items-center h-64">
              <div className="spinner"></div>
            </div>
          ) : error ? (
            <ErrorView retry={() => window.location.reload()} />
          ) : problems.length === 0 ? (
            <EmptyView />
          ) : filteredProblems.length === 0 ? (
            <EmptyFilterView clearFilters={clearFilters} />
          ) : (
            <div>
              {showFilters && (
                <FilterPanel
                  maxDistance={maxDistance}
                  setMaxDistance={setMaxDistance}
                  selectedStatuses={selectedStatuses}
                  toggleStatus={toggleStatus}
                  selectedCategories={selectedCategories}
                  toggleCategory={toggleCategory}
                  selectedUrgencies={selectedUrgencies}
                  toggleUrgency={toggleUrgency}
                  clearFilters={clearFilters}
                />
              )}
              <div className="mt-4">
                {filteredProblems.map(p => (
                  <ProblemCard key={p.id} problem={p} userLocation={userLocation} />
                ))}
              </div>
            </div>
          )}
        </div>
      );
    };

    // Render React app
    ReactDOM.render(<CasosScreen />, document.getElementById('root'));

    // Handle logout
    document.getElementById('logoutLink').addEventListener('click', (e) => {
      e.preventDefault();
      const logoutBtn = document.getElementById('logoutLink');
      const logoutText = logoutBtn.querySelector('span') || logoutBtn;
      const logoutSpinner = document.createElement('span');
      logoutSpinner.className = 'spinner';
      logoutText.style.display = 'none';
      logoutBtn.appendChild(logoutSpinner);
      logoutBtn.disabled = true;
      firebaseAuth.logout(logoutBtn, logoutText, logoutSpinner);
    });
  </script>
</body>
</html>