<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="FixABairro - Relatar Novo Problema">
  <meta name="keywords" content="fixabairro, angola, serviços públicos, cidadania, denúncias">
  <meta name="author" content="FixABairro Team">
  <link rel="icon" type="image/png" href="favicon.png"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <title>FixABairro | Novo Relato</title>
  <style>
    :root {
      --primary-color: #1e40af;
      --secondary-color: #22c55e;
      --highlight-color: #f59e0b;
      --dark-bg: #1f2937;
      --dark-card: #2d3748;
      --light-text: #f3f4f6;
      --card-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      --border-radius: 12px;
      --accent-color: #3b82f6;
      --danger-color: #ef4444;
      --warning-color: #f59e0b;
      --info-color: #0ea5e9;
    }

    html, body {
      font-family: 'Inter', sans-serif;
      color: var(--light-text);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      scroll-behavior: smooth;
    }

    body {
      background: linear-gradient(rgba(31, 41, 55, 0.85), rgba(31, 41, 55, 0.95)), url('https://images.trustinnews.pt/uploads/sites/5/2021/03/30631487-1600x1067.jpg') no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
      position: relative;
    }

    #particles-js {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
    }

    .navbar {
      background: rgba(31, 41, 55, 0.95);
      backdrop-filter: blur(20px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 1rem 2rem;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .navbar.scrolled {
      padding: 0.5rem 2rem;
    }

    .navbar-brand {
      display: flex;
      align-items: center;
      font-weight: 700;
      font-size: 1.75rem;
      color: white;
    }

    .logo {
      width: 40px;
      height: 40px;
      margin-right: 12px;
      filter: drop-shadow(0 0 8px rgba(30, 64, 175, 0.5));
      transition: transform 0.3s ease;
    }

    .navbar-brand:hover .logo {
      transform: scale(1.1) rotate(10deg);
    }

    .nav-link {
      font-weight: 500;
      position: relative;
      margin: 0 0.75rem;
      padding: 0.5rem 1rem !important;
      transition: all 0.3s ease;
      color: var(--light-text) !important;
    }

    .nav-link:not(.btn)::after {
      content: '';
      position: absolute;
      width: 0;
      height: 2px;
      bottom: 0;
      left: 50%;
      background-color: var(--primary-color);
      transition: all 0.3s ease;
    }

    .nav-link:not(.btn):hover::after {
      width: 80%;
      left: 10%;
    }

    .nav-link.btn {
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      border: none;
      border-radius: 50px;
      padding: 0.6rem 1.75rem !important;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.5);
      color: white !important;
      transition: all 0.3s ease;
    }

    .nav-link.btn:hover {
      transform: translateY(-2px) scale(1.1);
      box-shadow: 0 8px 16px rgba(30, 64, 175, 0.7);
    }

    .container {
      max-width: 80%;
      width: 58%;
      height: 550px;
      background-color: var(--dark-card);
      overflow: hidden;
      position: absolute;
      top: 50%;
      left: 50%;
      padding: 10px;
      transform: translate(-50%, -50%);
      display: flex;
      justify-content: left;
      align-items: top;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
    }

    .sidebar {
      width: 30%;
      background: linear-gradient(135deg, var(--primary-color), var(--dark-bg));
      border-radius: var(--border-radius);
      color: var(--light-text);
    }

    .sidebar ul {
      list-style: none;
      display: flex;
      flex-direction: column;
      padding: 1.5rem;
    }

    .sidebar ul li {
      display: flex;
      align-items: center;
      margin: 1rem 0;
    }

    .list-num {
      width: 30px;
      height: 30px;
      margin-right: 1rem;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--accent-color);
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .lists-active {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
      color: var(--dark-bg);
    }

    .side-content {
      display: flex;
      flex-direction: column;
    }

    .side-content p {
      font-size: 0.875rem;
      color: rgba(243, 244, 246, 0.7);
      text-transform: uppercase;
    }

    .side-content .info {
      font-size: 1rem;
      text-transform: uppercase;
    }

    @media screen and (max-width: 900px) {
      .container {
        max-width: 100%;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        padding: 0;
        box-shadow: 0px 0px 0px;
        border-radius: 0;
      }

      .sidebar {
        width: 100%;
        height: 30%;
        background: linear-gradient(135deg, var(--primary-color), var(--dark-bg));
        display: flex;
        border-radius: 0px;
        justify-content: center;
      }

      .sidebar ul {
        display: flex;
        flex-direction: row;
        align-items: center;
        margin-left: -25px;
      }

      .sidebar ul li .side-content {
        display: none;
      }

      .sidebar .list-num {
        margin: 0 20px;
        margin-top: -100px;
      }

      .step-one-container, .step-two-container, .step-three-container {
        max-width: 90%;
        width: 85%;
        height: 70vh;
        background-color: var(--dark-card);
        padding: 10px 20px;
        margin: 0 auto;
        margin-top: -100px;
        border-radius: 10px;
        box-shadow: var(--card-shadow);
      }

      .btns {
        width: 100%;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        margin-top: 60px;
      }
    }

    .step-one-container, .step-two-container, .step-three-container {
      width: 60%;
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 20px 70px;
      position: relative;
    }

    .header-sec {
      width: 100%;
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .header-sec .title {
      color: var(--primary-color);
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .header-sec .info-p {
      color: rgba(243, 244, 246, 0.9);
      font-size: 1.1rem;
    }

    .input-container {
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .input-content {
      width: 100%;
      display: flex;
      flex-direction: column;
      margin: 1rem 0;
    }

    .input-content label {
      font-size: 1rem;
      padding: 0.5rem 0;
      color: var(--light-text);
    }

    .input-content input, .input-content select, .input-content textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--light-text);
      transition: all 0.3s ease;
    }

    .input-content input:focus, .input-content select:focus, .input-content textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(30, 64, 175, 0.25);
    }

    .input-content .input-error {
      border-color: var(--danger-color);
    }

    .error-feild {
      font-size: 0.9rem;
      color: var(--danger-color);
      margin-top: 0.25rem;
      display: none;
    }

    .category-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .category-chip {
      padding: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.05);
    }

    .category-chip:hover {
      background: rgba(30, 64, 175, 0.2);
      border-color: var(--primary-color);
    }

    .category-chip.selected {
      background: var(--primary-color);
      border-color: var(--accent-color);
      color: var(--light-text);
    }

    .urgency-radio {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .urgency-radio label {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.05);
    }

    .urgency-radio input:checked + label {
      background: var(--primary-color);
      border-color: var(--accent-color);
      color: var(--light-text);
    }

    .image-upload-container {
      width: 100%;
      padding: 1.5rem;
      border: 2px dashed rgba(30, 64, 175, 0.3);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.02);
    }

    .image-upload-container:hover {
      border-color: var(--primary-color);
      background: rgba(30, 64, 175, 0.1);
    }

    .image-preview-container {
      width: 100%;
      margin-top: 1rem;
      border: 1px solid rgba(30, 64, 175, 0.2);
      border-radius: 8px;
      overflow: hidden;
      display: none;
    }

    .image-preview {
      width: 100%;
      height: auto;
      object-fit: cover;
    }

    .map-container {
      width: 100%;
      height: 200px;
      border: 1px solid rgba(30, 64, 175, 0.2);
      border-radius: 8px;
      margin: 1rem 0;
      position: relative;
    }

    .map-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      z-index: 1000;
    }

    .map-controls button {
      background: var(--dark-card);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--light-text);
      padding: 5px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .map-controls button:hover {
      background: var(--primary-color);
    }

    .btns button {
      outline: none;
      border: none;
      padding: 0.75rem 2rem;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: var(--light-text);
      font-weight: 600;
      border-radius: 50px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .btns button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btns button:hover:not(:disabled) {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 6px 12px rgba(30, 64, 175, 0.5);
    }

    .btns .prev-btn {
      background: none;
      border: 1px solid var(--light-text);
      color: var(--light-text);
    }

    .btns .prev-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .spinner {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--light-text);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="particles-js"></div>
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container">
      <a class="navbar-brand" href="index.html" aria-label="Página inicial do FixABairro">
        <img src="icons/Icon-192.png" alt="Logo FixABairro" class="logo">
        FixABairro
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Abrir menu de navegação">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="report.html" aria-label="Mapa de problemas">Mapa de Problemas</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html" aria-label="Dashboard">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link btn btn-primary" href="new-report.html" aria-label="Relatar um problema"><i class="fas fa-bullhorn me-1"></i> Relatar Problema</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Menu de perfil">
              Perfil
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
              <li><a class="dropdown-item" href="profile.html" aria-label="Ver perfil">Ver Perfil</a></li>
              <li><a class="dropdown-item" href="#" id="logoutLink" aria-label="Sair">Sair</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="sidebar">
      <ul>
        <li>
          <span class="list-num lists-active">1</span>
          <div class="side-content">
            <p>STEP 1</p>
            <span class="info">Informações Básicas</span>
          </div>
        </li>
        <li>
          <span class="list-num">2</span>
          <div class="side-content">
            <p>STEP 2</p>
            <span class="info">Detalhes</span>
          </div>
        </li>
        <li>
          <span class="list-num">3</span>
          <div class="side-content">
            <p>STEP 3</p>
            <span class="info">Localização</span>
          </div>
        </li>
      </ul>
    </div>

    <div class="step-one-container" data-aos="fade-up">
      <div class="header-sec">
        <h2 class="title">Novo Relato</h2>
        <p class="info-p">Descreva o problema em detalhes para ajudar na resolução.</p>
      </div>
      <div class="input-container">
        <div class="input-content">
          <label for="title">Título do Problema</label>
          <input type="text" id="title" placeholder="Ex.: Buraco na rua principal">
          <div class="error-feild" id="titleError"></div>
        </div>
        <div class="input-content">
          <label for="municipality">Município</label>
          <select id="municipality">
            <option value="">Selecione um município</option>
            <option value="Belas">Belas</option>
            <option value="Cacuaco">Cacuaco</option>
            <option value="Cazenga">Cazenga</option>
            <option value="Ícolo e Bengo">Ícolo e Bengo</option>
            <option value="Luanda">Luanda</option>
            <option value="Quiçama">Quiçama</option>
            <option value="Kilamba Kiaxi">Kilamba Kiaxi</option>
            <option value="Talatona">Talatona</option>
            <option value="Viana">Viana</option>
          </select>
          <div class="error-feild" id="municipalityError"></div>
        </div>
        <div class="input-content">
          <label for="neighborhood">Bairro</label>
          <select id="neighborhood" disabled>
            <option value="">Selecione um bairro</option>
          </select>
          <div class="error-feild" id="neighborhoodError"></div>
        </div>
        <div class="input-content">
          <label>Tipo de Problema</label>
          <div class="category-grid">
            <div class="category-chip selected" data-category="Buraco"><i class="fas fa-exclamation-circle" style="color: var(--warning-color)"></i> Buraco</div>
            <div class="category-chip" data-category="Lixo"><i class="fas fa-trash" style="color: var(--secondary-color)"></i> Lixo</div>
            <div class="category-chip" data-category="Iluminação"><i class="fas fa-lightbulb" style="color: var(--warning-color)"></i> Iluminação</div>
            <div class="category-chip" data-category="Água"><i class="fas fa-tint" style="color: var(--info-color)"></i> Água</div>
            <div class="category-chip" data-category="Segurança"><i class="fas fa-shield-alt" style="color: var(--danger-color)"></i> Segurança</div>
            <div class="category-chip" data-category="Outros"><i class="fas fa-ellipsis-h" style="color: var(--light-text)"></i> Outros</div>
          </div>
          <div class="error-feild" id="categoryError"></div>
        </div>
        <div class="input-content">
          <label>Nível de Urgência</label>
          <div class="urgency-radio">
            <input type="radio" name="urgency" id="urgency-Baixa" value="Baixa" checked>
            <label for="urgency-Baixa"><i class="fas fa-tachometer-alt" style="color: var(--secondary-color)"></i> Baixa</label>
            <input type="radio" name="urgency" id="urgency-Média" value="Média">
            <label for="urgency-Média"><i class="fas fa-exclamation-triangle" style="color: var(--warning-color)"></i> Média</label>
            <input type="radio" name="urgency" id="urgency-Alta" value="Alta">
            <label for="urgency-Alta"><i class="fas fa-exclamation-circle" style="color: var(--danger-color)"></i> Alta</label>
          </div>
          <div class="error-feild" id="urgencyError"></div>
        </div>
      </div>
      <div class="btns">
        <button id="nextBtn"><span id="nextText">Próximo</span><span id="nextSpinner" class="spinner" style="display: none;"></span></button>
      </div>
    </div>

    <div class="step-two-container" data-aos="fade-up">
      <div class="header-sec">
        <h2 class="title">Detalhes</h2>
        <p class="info-p">Forneça mais informações sobre o problema.</p>
      </div>
      <div class="input-container">
        <div class="input-content">
          <label for="description">Descrição Detalhada</label>
          <textarea id="description" rows="5" placeholder="Descreva o problema em detalhes"></textarea>
          <div class="error-feild" id="descriptionError"></div>
        </div>
        <div class="input-content">
          <label for="image">Adicione uma Foto</label>
          <div class="image-upload-container" id="imageUpload">
            <i class="fas fa-camera fa-2x" style="color: rgba(255, 255, 255, 0.6)"></i>
            <p>Clique para selecionar uma imagem</p>
            <input type="file" id="image" accept="image/*" style="display: none;">
          </div>
          <div class="error-feild" id="imageError"></div>
        </div>
      </div>
      <div class="btns">
        <button id="prevBtn" class="prev-btn">Voltar</button>
        <button id="nextBtn"><span id="nextText">Próximo</span><span id="nextSpinner" class="spinner" style="display: none;"></span></button>
      </div>
    </div>

    <div class="step-three-container" data-aos="fade-up">
      <div class="header-sec">
        <h2 class="title">Localização</h2>
        <p class="info-p">Marque a localização do problema no mapa.</p>
      </div>
      <div class="input-container">
        <div class="input-content">
          <label>Localização</label>
          <div class="map-container" id="formMap">
            <div class="map-controls">
              <button id="zoomIn" title="Aumentar zoom"><i class="fas fa-plus"></i></button>
              <button id="zoomOut" title="Diminuir zoom"><i class="fas fa-minus"></i></button>
              <button id="myLocation" title="Minha localização"><i class="fas fa-crosshairs"></i></button>
            </div>
          </div>
          <div class="error-feild" id="mapError"></div>
        </div>
        <div class="input-content">
          <label for="suggestion">Sugestão de Solução (opcional)</label>
          <textarea id="suggestion" rows="2" placeholder="Sugira uma solução"></textarea>
          <div class="error-feild" id="suggestionError"></div>
        </div>
      </div>
      <div class="btns">
        <button id="prevBtn" class="prev-btn">Voltar</button>
        <button id="nextBtn"><span id="nextText">Enviar</span><span id="nextSpinner" class="spinner" style="display: none;"></span></button>
      </div>
    </div>
  </div>

  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <script>
    let currentStep = 0;
    let formData = {
      title: '',
      category: 'Buraco',
      urgency: 'Baixa',
      description: '',
      suggestion: '',
      image: null,
      latitude: null,
      longitude: null,
      municipality: '',
      neighborhood: ''
    };
    let map, marker;

    const municipalitiesAndNeighborhoods = {
      'Belas': ['Morro Bento', 'Benfica', 'Vila Estoril', 'Talatona', 'Kilamba', 'Barra do Kwanza', 'Quilamba', 'Cabolombo', 'Quifica', 'Gamek', 'Salvador Allende', 'Quiminha', 'Quenguela', 'Ramiros', 'Vila Verde', 'Zango 1', 'Zango 2', 'Zango 3', 'Zango 4', 'Zango 5', 'Zango 6', 'Zango 7', 'Zango 8', 'Zango 9', 'Zango 0'],
      'Cacuaco': ['Kikolo', 'Sequele', 'Mulenvos', 'Cacuaco Praia', 'Kiaxi Grande', '4 de Fevereiro', 'Baía do Bengo', 'Kicolo', 'Kifangondo', 'Funda', 'Cabiri', 'Panguila', 'Quicolo', 'Quixinge', 'Quilómetro 44', 'Bom Jesus', 'Cabeleira', 'Caxito', 'Mabubas', 'Quiangombe', 'Quilómetro 30', 'Quilómetro 36', 'Quilómetro 40', 'Quilómetro 42', 'Quilómetro 45', 'Quilómetro 50'],
      'Cazenga': ['Hoji Ya Henda', '11 de Novembro', 'Kima Kienda', 'São Pedro', 'Tala Hady', 'Cazenga Popular', 'Kabolombota', 'Kambamba', 'Kassa Kala', 'Kawa', 'Kicolo', 'Kilemba', 'Kimbamba', 'Kimbango', 'Kinda', 'Kintambi', 'Kipata', 'Kuanza', 'Kueio', 'Luanda Sul', 'Mabubas', 'Maculusso', 'Mabor', 'Maianga', 'Makulusu', 'Malangino', 'Marçal', 'Ngola Kiluange', 'Palmeirinhas', 'Rocha Pinto', 'Rangel', 'Sambizanga', 'São Paulo', 'Uíge', 'Vila Alice', 'Vila Estoril', 'Vila Flor', 'Vila Verde'],
      'Ícolo e Bengo': ['Catete', 'Bom Jesus', 'Caculo Cahango', 'Cassoneca', 'Demba Chio', 'Kibaxe', 'Kicabo', 'Kifangondo', 'Kikabo', 'Kilemba', 'Kixico', 'Luanda', 'Muxima', 'Panguila', 'Quiminha', 'Quixinge', 'Tabi', 'Zenza do Itombe'],
      'Luanda': ['Maianga', 'Ingombota', 'Maculusso', 'Sambizanga', 'Rangel', 'Kinaxixi', 'Prenda', 'Bairro Operário', 'Bairro Azul', 'Bairro Popular', 'Bairro dos Musseques', 'Bairro da Samba', 'Bairro do Cazenga', 'Bairro do Rocha Pinto', 'Bairro do São Paulo', 'Bairro do Uíge', 'Bairro da Vila Alice', 'Bairro da Vila Estoril', 'Bairro da Vila Flor', 'Bairro da Vila Verde', 'Bairro do Marçal', 'Bairro do Ngola Kiluange', 'Bairro do Kuanza', 'Bairro do Kilemba', 'Bairro do Kintambi', 'Bairro do Kimbamba', 'Bairro do Kimbango', 'Bairro do Kinda', 'Bairro do Kipata', 'Bairro do Kueio', 'Bairro do Luanda Sul', 'Bairro do Mabubas', 'Bairro do Mabor', 'Bairro do Makulusu', 'Bairro do Malangino', 'Bairro do Palmeirinhas', 'Bairro do Rocha Pinto', 'Bairro do São Paulo', 'Bairro do Uíge', 'Bairro da Vila Alice', 'Bairro da Vila Estoril', 'Bairro da Vila Flor', 'Bairro da Vila Verde'],
      'Quiçama': ['Quiçama', 'Cabo Ledo', 'Demba Chio', 'Kissama', 'Mumbondo', 'Quiminha', 'Quixinge', 'Zenza do Itombe'],
      'Kilamba Kiaxi': ['Palanca', 'Golfe', 'Cassequel', 'Sapú', 'Camama', 'Cidade Universitária', 'Vila de Viana', 'Bairro da Paz', 'Bairro da Boavista', 'Bairro da Camama', 'Bairro da Cidade Universitária', 'Bairro da Golfe', 'Bairro da Palanca', 'Bairro da Sapú', 'Bairro da Vila de Viana', 'Bairro do Cassequel', 'Bairro do Prenda', 'Bairro do Kinaxixi', 'Bairro do Maculusso', 'Bairro do Rangel', 'Bairro do Sambizanga', 'Bairro do São Paulo', 'Bairro do Uíge', 'Bairro da Vila Alice', 'Bairro da Vila Estoril', 'Bairro da Vila Flor', 'Bairro da Vila Verde'],
      'Talatona': ['Futungo de Belas', 'Camama', 'Vida Pacífica', 'Benfica', 'Vila Estoril', 'Talatona', 'Kilamba', 'Barra do Kwanza', 'Quilamba', 'Cabolombo', 'Quifica', 'Gamek', 'Salvador Allende', 'Quiminha', 'Quenguela', 'Ramiros', 'Vila Verde', 'Zango 1', 'Zango 2', 'Zango 3', 'Zango 4', 'Zango 5', 'Zango 6', 'Zango 7', 'Zango 8', 'Zango 9', 'Zango 0'],
      'Viana': ['Estalagem', 'Zango', 'Viana Centro', 'Baía', 'Kikolo', 'Sequele', 'Mulenvos', 'Cacuaco Praia', 'Kiaxi Grande', '4 de Fevereiro', 'Baía do Bengo', 'Kicolo', 'Kifangondo', 'Funda', 'Cabiri', 'Panguila']
    };

    const cloudinaryConfig = {
      cloudName: 'dlfukiusa',
      apiKey: '438687859144979',
      apiSecret: 'Fpco6q6IczfTOh-Lv5r0t1C1tMk',
      uploadPreset: 'fixabairro',
      folder: 'fixa/Desconhecido'
    };

    const categories = [
      { name: 'Buraco', icon: 'fa-exclamation-circle', color: '#f59e0b' },
      { name: 'Lixo', icon: 'fa-trash', color: '#22c55e' },
      { name: 'Iluminação', icon: 'fa-lightbulb', color: '#f59e0b' },
      { name: 'Água', icon: 'fa-tint', color: '#0ea5e9' },
      { name: 'Segurança', icon: 'fa-shield-alt', color: '#ef4444' },
      { name: 'Outros', icon: 'fa-ellipsis-h', color: '#9ca3af' }
    ];

    const urgencies = [
      { level: 'Baixa', icon: 'fa-tachometer-alt', color: '#22c55e' },
      { level: 'Média', icon: 'fa-exclamation-triangle', color: '#f59e0b' },
      { level: 'Alta', icon: 'fa-exclamation-circle', color: '#ef4444' }
    ];

    function showError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
      }
    }

    function hideError(elementId) {
      const errorElement = document.getElementById(elementId);
      if (errorElement) {
        errorElement.style.display = 'none';
      }
    }

    async function getResponsibleIdForMunicipality(firebase, municipality) {
      try {
        const querySnapshot = await firebase.firestore()
          .collection('usuarios')
          .where('municipality', '==', municipality)
          .where('isResponsible', '==', true)
          .limit(1)
          .get();
        if (!querySnapshot.empty) {
          return querySnapshot.docs[0].id;
        }
        console.log(`Nenhum responsável encontrado para o município: ${municipality}`);
        return null;
      } catch (error) {
        console.error("Erro ao buscar responsável:", error.message);
        return null;
      }
    }

    async function uploadToCloudinary(file, neighborhood) {
      const timestamp = Math.floor(Date.now() / 1000);
      const folder = neighborhood ? `fixa/${neighborhood}` : cloudinaryConfig.folder;
      const paramsToSign = {
        timestamp,
        upload_preset: cloudinaryConfig.uploadPreset,
        folder
      };

      const sortedParams = Object.keys(paramsToSign).sort().reduce((obj, key) => {
        obj[key] = paramsToSign[key];
        return obj;
      }, {});
      let signatureString = '';
      for (const [key, value] of Object.entries(sortedParams)) {
        if (key !== 'file' && key !== 'api_key') {
          signatureString += `${key}=${value}&`;
        }
      }
      signatureString = signatureString.slice(0, -1) + cloudinaryConfig.apiSecret;
      const signature = CryptoJS.SHA1(signatureString).toString();

      const formData = new FormData();
      formData.append('file', file);
      formData.append('api_key', cloudinaryConfig.apiKey);
      formData.append('timestamp', timestamp);
      formData.append('signature', signature);
      formData.append('upload_preset', cloudinaryConfig.uploadPreset);
      formData.append('folder', folder);

      const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`, {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`Falha no upload: ${response.status} - ${errorData.error.message}`);
      }

      const data = await response.json();
      return data.secure_url;
    }

    function initializeMap() {
      if (map) map.remove();
      map = L.map('formMap').setView([-8.838333, 13.234444], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(map);

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const { latitude, longitude } = position.coords;
            map.setView([latitude, longitude], 15);
            formData.latitude = latitude;
            formData.longitude = longitude;
            marker = L.marker([latitude, longitude], { draggable: true }).addTo(map);
            marker.on('dragend', () => {
              formData.latitude = marker.getLatLng().lat;
              formData.longitude = marker.getLatLng().lng;
            });
          },
          () => {
            marker = L.marker([-8.838333, 13.234444], { draggable: true }).addTo(map);
            formData.latitude = -8.838333;
            formData.longitude = 13.234444;
            marker.on('dragend', () => {
              formData.latitude = marker.getLatLng().lat;
              formData.longitude = marker.getLatLng().lng;
            });
          }
        );
      } else {
        marker = L.marker([-8.838333, 13.234444], { draggable: true }).addTo(map);
        formData.latitude = -8.838333;
        formData.longitude = 13.234444;
        marker.on('dragend', () => {
          formData.latitude = marker.getLatLng().lat;
          formData.longitude = marker.getLatLng().lng;
        });
      }

      map.on('click', (e) => {
        if (marker) {
          marker.setLatLng(e.latlng);
        } else {
          marker = L.marker(e.latlng, { draggable: true }).addTo(map);
        }
        formData.latitude = e.latlng.lat;
        formData.longitude = e.latlng.lng;
        marker.on('dragend', () => {
          formData.latitude = marker.getLatLng().lat;
          formData.longitude = marker.getLatLng().lng;
        });
      });

      document.getElementById('zoomIn').addEventListener('click', () => {
        map.setZoom(map.getZoom() + 1);
      });
      document.getElementById('zoomOut').addEventListener('click', () => {
        map.setZoom(map.getZoom() - 1);
      });
      document.getElementById('myLocation').addEventListener('click', () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(position => {
            const { latitude, longitude } = position.coords;
            map.setView([latitude, longitude], 15);
            if (marker) {
              marker.setLatLng([latitude, longitude]);
            } else {
              marker = L.marker([latitude, longitude], { draggable: true }).addTo(map);
            }
            formData.latitude = latitude;
            formData.longitude = longitude;
          });
        }
      });
    }

    function loadStep() {
      const stepContainers = document.querySelectorAll('.step-one-container, .step-two-container, .step-three-container');
      const stepNumbers = document.querySelectorAll('.list-num');
      stepContainers.forEach((container, index) => {
        container.style.display = index === currentStep ? 'block' : 'none';
      });
      stepNumbers.forEach((num, index) => {
        num.classList.toggle('lists-active', index === currentStep);
      });
      if (currentStep === 2) initializeMap();
    }

    function updateStep() {
      const stepNumbers = document.querySelectorAll('.list-num');
      stepNumbers.forEach((num, index) => {
        num.classList.toggle('lists-active', index === currentStep);
      });
      loadStep();
    }

    function loadFormData(firebase) {
      firebase.auth().onAuthStateChanged(async user => {
        const container = document.querySelector('.container');
        if (!user) {
          container.innerHTML = `
            <div style="color: var(--danger-color); text-align: center; padding: 2rem;">Por favor, faça login para relatar um problema.</div>
          `;
          setTimeout(() => window.location.href = 'login.html', 2000);
          return;
        }

        try {
          const userDoc = await firebase.firestore().collection('usuarios').doc(user.uid).get();
          const userData = userDoc.exists ? userDoc.data() : { nome: user.displayName || "Usuário", email: user.email || "" };
          formData.municipality = userData.municipality || Object.keys(municipalitiesAndNeighborhoods)[0];
          const municipalitySelect = document.getElementById('municipality');
          municipalitySelect.value = formData.municipality;
          municipalitySelect.dispatchEvent(new Event('change'));
          loadStep();
        } catch (error) {
          console.error("Erro ao carregar dados:", error.message);
          container.innerHTML = `
            <div style="color: var(--danger-color); text-align: center; padding: 2rem;">Erro ao carregar formulário. Verifique sua conexão.</div>
          `;
        }
      });
    }

    function handleLogout(firebase) {
      return function(e) {
        e.preventDefault();
        const logoutBtn = document.getElementById('logoutLink');
        const logoutText = logoutBtn.querySelector('span') || logoutBtn;
        const logoutSpinner = document.createElement('span');
        logoutSpinner.className = 'spinner';
        logoutText.style.display = 'none';
        logoutBtn.appendChild(logoutSpinner);
        logoutBtn.disabled = true;

        firebase.auth().signOut().then(() => {
          window.location.href = 'login.html';
        }).catch(error => {
          console.error("Erro ao fazer logout:", error.message);
          logoutText.style.display = 'inline-block';
          logoutSpinner.remove();
          logoutBtn.disabled = false;
          alert('Erro ao fazer logout: ' + error.message);
        });
      };
    }

    window.addEventListener('load', () => {
      if (typeof AOS !== 'undefined') {
        AOS.init({
          duration: 800,
          easing: 'ease-in-out',
          once: true
        });
      } else {
        console.warn('AOS library not loaded');
      }

      if (typeof particlesJS !== 'undefined') {
        particlesJS('particles-js', {
          particles: {
            number: { value: 20, density: { enable: true, value_area: 1000 } },
            color: { value: ['#1e40af', '#22c55e', '#f59e0b'] },
            shape: { type: 'circle' },
            opacity: { value: 0.4, random: true },
            size: { value: 3, random: true },
            line_linked: { enable: false },
            move: { enable: true, speed: 0.8, direction: 'none', random: true }
          },
          interactivity: {
            detect_on: 'canvas',
            events: { onhover: { enable: true, mode: 'repulse' }, onclick: { enable: true, mode: 'push' } },
            modes: { repulse: { distance: 100 }, push: { particles_nb: 4 } }
          },
          retina_detect: true
        });
      } else {
        console.warn('Particles.js library not loaded');
      }

      if (typeof firebase !== 'undefined') {
        const firebaseConfig = {
          apiKey: "AIzaSyDVtY6ML3j-qrIsAprIJPB5xFFCbcf4UQw",
          authDomain: "facilita-479b3.firebaseapp.com",
          projectId: "facilita-479b3",
          storageBucket: "facilita-479b3.appspot.com",
          messagingSenderId: "385676676886",
          appId: "1:385676676886:web:6976de7f3abc6c0da94a37",
          databaseURL: "https://facilita-479b3-default-rtdb.firebaseio.com/"
        };
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }

        document.getElementById('title').addEventListener('input', (e) => {
          formData.title = e.target.value.trim();
          hideError('titleError');
        });

        document.getElementById('municipality').addEventListener('change', (e) => {
          formData.municipality = e.target.value;
          const neighborhoodSelect = document.getElementById('neighborhood');
          neighborhoodSelect.disabled = !formData.municipality;
          neighborhoodSelect.innerHTML = '<option value="">Selecione um bairro</option>';
          if (formData.municipality && municipalitiesAndNeighborhoods[formData.municipality]) {
            municipalitiesAndNeighborhoods[formData.municipality].forEach(nb => {
              const option = document.createElement('option');
              option.value = nb;
              option.textContent = nb;
              neighborhoodSelect.appendChild(option);
            });
          }
          hideError('municipalityError');
        });

        document.getElementById('neighborhood').addEventListener('change', (e) => {
          formData.neighborhood = e.target.value;
          hideError('neighborhoodError');
        });

        document.querySelectorAll('.category-chip').forEach(chip => {
          chip.addEventListener('click', () => {
            document.querySelectorAll('.category-chip').forEach(c => c.classList.remove('selected'));
            chip.classList.add('selected');
            formData.category = chip.dataset.category;
            hideError('categoryError');
          });
        });

        document.querySelectorAll('input[name="urgency"]').forEach(radio => {
          radio.addEventListener('change', (e) => {
            formData.urgency = e.target.value;
            hideError('urgencyError');
          });
        });

        document.getElementById('description').addEventListener('input', (e) => {
          formData.description = e.target.value.trim();
          hideError('descriptionError');
        });

        const imageUpload = document.getElementById('imageUpload');
        const imageInput = document.getElementById('image');
        imageUpload.addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            formData.image = file;
            const reader = new FileReader();
            reader.onload = (e) => {
              const previewContainer = document.createElement('div');
              previewContainer.className = 'image-preview-container';
              previewContainer.id = 'imagePreviewContainer';
              previewContainer.style.display = 'block';
              previewContainer.innerHTML = `<img id="imagePreview" class="image-preview" src="${e.target.result}" alt="Prévia da imagem">`;
              imageUpload.innerHTML = '';
              imageUpload.appendChild(previewContainer);
            };
            reader.readAsDataURL(file);
            hideError('imageError');
          }
        });

        document.getElementById('suggestion').addEventListener('input', (e) => {
          formData.suggestion = e.target.value.trim();
        });

        document.querySelectorAll('#prevBtn').forEach(btn => {
          btn.addEventListener('click', () => {
            if (currentStep > 0) {
              currentStep--;
              updateStep();
            }
          });
        });

        document.querySelectorAll('#nextBtn').forEach(btn => {
          btn.addEventListener('click', async () => {
            let isValid = true;
            const nextText = btn.querySelector('#nextText');
            const nextSpinner = btn.querySelector('#nextSpinner');

            if (currentStep === 0) {
              if (!formData.title) {
                showError('titleError', 'Por favor, insira um título');
                isValid = false;
              }
              if (!formData.municipality) {
                showError('municipalityError', 'Por favor, selecione um município');
                isValid = false;
              }
              if (!formData.neighborhood) {
                showError('neighborhoodError', 'Por favor, selecione um bairro');
                isValid = false;
              }
              if (!formData.category) {
                showError('categoryError', 'Por favor, selecione uma categoria');
                isValid = false;
              }
              if (!formData.urgency) {
                showError('urgencyError', 'Por favor, selecione o nível de urgência');
                isValid = false;
              }
            }

            if (currentStep === 1) {
              if (!formData.description) {
                showError('descriptionError', 'Por favor, insira uma descrição');
                isValid = false;
              }
              if (!formData.image) {
                showError('imageError', 'Por favor, adicione uma imagem');
                isValid = false;
              }
            }

            if (currentStep === 2) {
              if (!formData.latitude || !formData.longitude) {
                showError('mapError', 'Por favor, selecione uma localização');
                isValid = false;
              }
            }

            if (!isValid) return;

            if (currentStep < 2) {
              currentStep++;
              updateStep();
            } else {
              nextText.style.display = 'none';
              nextSpinner.style.display = 'inline-block';
              btn.disabled = true;

              try {
                const user = firebase.auth().currentUser;
                if (!user) throw new Error('Usuário não autenticado');

                const imageUrl = await uploadToCloudinary(formData.image, formData.neighborhood);
                const responsibleId = await getResponsibleIdForMunicipality(firebase, formData.municipality);

                const problemData = {
                  usuarioId: user.uid,
                  title: formData.title,
                  category: formData.category,
                  urgency: formData.urgency,
                  description: formData.description,
                  suggestion: formData.suggestion || '',
                  imageUrl,
                  location: {
                    latitude: formData.latitude,
                    longitude: formData.longitude
                  },
                  status: 'Aguardando',
                  createdAt: Date.now(),
                  neighborhood: formData.neighborhood,
                  municipality: formData.municipality,
                  responsibleId: responsibleId || null
                };

                await firebase.database().ref('problems').push(problemData);
                alert('Problema relatado com sucesso!');
                window.location.href = 'report.html';
              } catch (error) {
                console.error('Erro ao relatar problema:', error.message);
                showError('mapError', 'Erro ao relatar problema.');
              } finally {
                nextText.style.display = 'inline-block';
                nextSpinner.style.display = 'none';
                btn.disabled = false;
              }
            }
          });
        });

        loadFormData(firebase);
        document.getElementById('logoutLink').addEventListener('click', handleLogout(firebase));
      } else {
        console.warn('Firebase SDK not loaded');
        const container = document.querySelector('.container');
        container.innerHTML = `
          <div style="color: var(--danger-color); text-align: center; padding: 2rem;">Erro ao carregar formulário. Verifique sua conexão.</div>
        `;
      }

      window.addEventListener('scroll', () => {
        const navbar = document.querySelector('.navbar');
        navbar.classList.toggle('scrolled', window.scrollY > 50);
      });
    });
  </script>
</body>
</html>