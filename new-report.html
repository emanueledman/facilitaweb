<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="FixABairro - Relatar Novo Problema">
  <meta name="keywords" content="fixabairro, angola, serviços públicos, cidadania, denúncias">
  <meta name="author" content="FixABairro Team">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- AOS Animation Library -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <title>FixABairro | Novo Relato</title>
  <style>
    :root {
      --primary-color: #1e40af;
      --secondary-color: #22c55e;
      --highlight-color: #f59e0b;
      --dark-bg: #1f2937;
      --dark-card: #2d3748;
      --light-text: #f3f4f6;
      --card-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      --border-radius: 12px;
      --accent-color: #3b82f6;
      --danger-color: #ef4444;
      --warning-color: #f59e0b;
      --info-color: #0ea5e9;
    }
    
    html, body {
      font-family: 'Inter', sans-serif;
      color: var(--light-text);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      scroll-behavior: smooth;
      background-color: var(--dark-bg);
    }
    
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(rgba(31, 41, 55, 0.85), rgba(31, 41, 55, 0.95)), url('https://images.trustinnews.pt/uploads/sites/5/2021/03/30631487-1600x1067.jpg') no-repeat center center fixed;
      background-size: cover;
    }
    
    .container {
      max-width: 80%;
      width: 60%;
      height: 600px;
      background-color: var(--dark-card);
      overflow: hidden;
      position: absolute;
      top: 50%;
      left: 50%;
      padding: 10px;
      transform: translate(-50%, -50%);
      display: flex;
      justify-content: left;
      align-items: top;
      border-radius: 10px;
      box-shadow: var(--card-shadow);
    }
    
    .sidebar {
      width: 30%;
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      border-radius: 10px;
      color: white;
      padding: 20px;
    }
    
    .sidebar ul {
      list-style: none;
      display: flex;
      flex-direction: column;
      padding: 0;
    }
    
    .sidebar ul li {
      display: flex;
      align-items: center;
      margin: 15px 0;
    }
    
    .step-num {
      width: 30px;
      height: 30px;
      margin-right: 15px;
      font-size: 14px;
      display: grid;
      place-items: center;
      border: 2px solid var(--light-text);
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    
    .step-active .step-num {
      background-color: var(--secondary-color);
      color: var(--dark-bg);
      border-color: var(--secondary-color);
    }
    
    .side-content p {
      font-size: 12px;
      text-transform: uppercase;
      opacity: 0.8;
    }
    
    .side-content .info {
      font-size: 14px;
      text-transform: uppercase;
      font-weight: 600;
    }
    
    .content {
      display: none;
    }
    
    .content.active {
      display: flex;
    }
    
    .step-container {
      width: 70%;
      display: flex;
      flex-direction: column;
      padding: 20px 50px;
      position: relative;
    }
    
    .header-sec {
      width: 100%;
      margin-bottom: 20px;
    }
    
    .header-sec h1 {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--light-text);
    }
    
    .header-sec p {
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .form-group {
      margin-bottom: 1.5rem;
      position: relative;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .form-control {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--light-text);
      border-radius: 8px;
      padding: 0.75rem;
      transition: all 0.3s ease;
      flex: 1;
      min-width: 200px;
    }
    
    .form-control:focus {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(30, 64, 175, 0.25);
      color: var(--light-text);
    }
    
    .form-control::placeholder {
      color: rgba(255, 255, 255, 0.6);
      opacity: 1;
    }
    
    .error-message {
      color: var(--danger-color);
      font-size: 0.9rem;
      margin-top: 0.25rem;
      text-align: center;
      padding: 0.5rem;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 4px;
      display: none;
      width: 100%;
    }
    
    .category-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .category-chip {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 0.75rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .category-chip:hover {
      background: rgba(30, 64, 175, 0.2);
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }
    
    .category-chip.selected {
      background: var(--primary-color);
      border-color: var(--accent-color);
      color: white;
      box-shadow: 0 4px 8px rgba(30, 64, 175, 0.3);
    }
    
    .urgency-radio {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .urgency-radio label {
      flex: 1;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 0.75rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .urgency-radio input {
      display: none;
    }
    
    .urgency-radio label:hover {
      background: rgba(30, 64, 175, 0.2);
      border-color: var(--primary-color);
    }
    
    .urgency-radio input:checked + label {
      background: var(--primary-color);
      border-color: var(--accent-color);
      color: white;
      box-shadow: 0 4px 8px rgba(30, 64, 175, 0.3);
    }
    
    .image-upload-container {
      position: relative;
      border: 2px dashed rgba(30, 64, 175, 0.3);
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.02);
    }
    
    .image-upload-container:hover {
      border-color: var(--primary-color);
      background: rgba(30, 64, 175, 0.1);
      transform: translateY(-2px);
    }
    
    .image-preview-container {
      position: relative;
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      margin-top: 1rem;
      overflow: hidden;
      display: none;
      border: 1px solid rgba(30, 64, 175, 0.2);
      box-shadow: var(--card-shadow);
    }
    
    .image-preview {
      width: 100%;
      height: auto;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    
    .image-preview:hover {
      transform: scale(1.03);
    }
    
    .map-container {
      height: 300px;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(30, 64, 175, 0.2);
      box-shadow: var(--card-shadow);
    }
    
    .map-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .map-control-btn {
      background: var(--dark-card);
      border: 1px solid rgba(30, 64, 175, 0.2);
      border-radius: 8px;
      padding: 0.5rem;
      cursor: pointer;
      color: var(--light-text);
      transition: all 0.3s ease;
      box-shadow: var(--card-shadow);
    }
    
    .map-control-btn:hover {
      background: var(--primary-color);
      border-color: var(--accent-color);
      color: white;
      transform: translateY(-2px);
    }
    
    .select-container {
      position: relative;
      flex: 1;
      min-width: 200px;
    }
    
    select.form-control {
      appearance: none;
      padding-right: 2.5rem;
      width: 100%;
    }
    
    .select-container::after {
      content: '\f078';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255, 255, 255, 0.6);
      pointer-events: none;
    }
    
    .btn-container {
      width: 100%;
      display: flex;
      flex-direction: row-reverse;
      justify-content: space-between;
      align-items: center;
      position: absolute;
      bottom: 20px;
      left: 50px;
    }
    
    .btn {
      outline: none;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .next-step {
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: white;
    }
    
    .next-step:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(30, 64, 175, 0.5);
    }
    
    .next-step:disabled {
      background: #6b7280;
      cursor: not-allowed;
      box-shadow: none;
    }
    
    .go-back {
      background: none;
      color: var(--light-text);
    }
    
    .go-back:hover {
      color: var(--secondary-color);
    }
    
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-left: 0.5rem;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media screen and (max-width: 900px) {
      .container {
        max-width: 100%;
        width: 100%;
        height: 100%;
        flex-direction: column;
        padding: 0;
        border-radius: 0;
        box-shadow: none;
      }
      
      .sidebar {
        width: 100%;
        height: 150px;
        border-radius: 0;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      
      .sidebar ul {
        flex-direction: row;
        margin: 0;
      }
      
      .sidebar ul li {
        margin: 0 10px;
      }
      
      .sidebar .side-content {
        display: none;
      }
      
      .step-container {
        max-width: 90%;
        width: 85%;
        background-color: var(--dark-card);
        padding: 20px;
        margin: -80px auto 0;
        border-radius: 10px;
        box-shadow: var(--card-shadow);
        min-height: 70vh;
      }
      
      .btn-container {
        position: fixed;
        bottom: 20px;
        left: 0;
        width: 100%;
        padding: 0 20px;
      }
      
      .map-container {
        height: 250px;
      }
      
      .form-control, .form-group label {
        font-size: 0.85rem;
      }
      
      .select-container {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <main class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <ul class="steps">
        <li class="step1 step-active">
          <div class="step-num">1</div>
          <div class="side-content">
            <p>Passo 1</p>
            <div class="info">Informações Básicas</div>
          </div>
        </li>
        <li class="step2">
          <div class="step-num">2</div>
          <div class="side-content">
            <p>Passo 2</p>
            <div class="info">Detalhes</div>
          </div>
        </li>
        <li class="step3">
          <div class="step-num">3</div>
          <div class="side-content">
            <p>Passo 3</p>
            <div class="info">Localização</div>
          </div>
        </li>
      </ul>
    </div>

    <!-- Step 1: Informações Básicas -->
    <div class="step-one-container content active">
      <div class="header-sec">
        <h1>Informações Básicas</h1>
        <p>Preencha os detalhes iniciais do problema.</p>
      </div>
      <div class="form-group">
        <label for="title">Título do Problema</label>
        <input type="text" class="form-control" id="title" placeholder="Ex.: Buraco na rua principal">
        <div class="error-message" id="titleError"></div>
      </div>
      <div class="form-group">
        <label for="municipality">Município</label>
        <div class="select-container">
          <select class="form-control" id="municipality">
            <option value="">Selecione um município</option>
          </select>
        </div>
        <div class="error-message" id="municipalityError"></div>
      </div>
      <div class="form-group">
        <label for="neighborhood">Bairro</label>
        <div class="select-container">
          <select class="form-control" id="neighborhood" disabled>
            <option value="">Selecione um bairro</option>
          </select>
        </div>
        <div class="error-message" id="neighborhoodError"></div>
      </div>
      <div class="form-group">
        <label>Tipo de Problema</label>
        <div class="category-grid" id="categoryGrid"></div>
        <div class="error-message" id="categoryError"></div>
      </div>
      <div class="form-group">
        <label>Nível de Urgência</label>
        <div class="urgency-radio" id="urgencyRadio"></div>
        <div class="error-message" id="urgencyError"></div>
      </div>
      <div class="btn-container">
        <button class="btn next-step" id="nextStep1">Próximo</button>
      </div>
    </div>

    <!-- Step 2: Detalhes -->
    <div class="step-two-container content">
      <div class="header-sec">
        <h1>Detalhes do Problema</h1>
        <p>Descreva o problema e adicione uma imagem.</p>
      </div>
      <div class="form-group">
        <label for="description">Descrição Detalhada</label>
        <textarea class="form-control" id="description" rows="5" placeholder="Descreva o problema em detalhes"></textarea>
        <div class="error-message" id="descriptionError"></div>
      </div>
      <div class="form-group">
        <label for="image">Adicione uma Foto</label>
        <div class="image-upload-container" id="imageUpload">
          <i class="fas fa-camera fa-2x" style="color: rgba(255, 255, 255, 0.6);"></i>
          <p>Clique para selecionar uma imagem</p>
          <input type="file" id="image" accept="image/*" style="display: none;">
        </div>
        <div class="error-message" id="imageError"></div>
      </div>
      <div class="btn-container">
        <button class="btn next-step" id="nextStep2">Próximo</button>
        <button class="btn go-back" id="goBack2">Voltar</button>
      </div>
    </div>

    <!-- Step 3: Localização -->
    <div class="step-three-container content">
      <div class="header-sec">
        <h1>Localização do Problema</h1>
        <p>Marque a localização exata no mapa.</p>
      </div>
      <div class="form-group">
        <label>Localização</label>
        <div class="map-container" id="formMap">
          <div class="map-controls">
            <button class="map-control-btn" id="zoomIn" aria-label="Aumentar zoom"><i class="fas fa-plus"></i></button>
            <button class="map-control-btn" id="zoomOut" aria-label="Diminuir zoom"><i class="fas fa-minus"></i></button>
            <button class="map-control-btn" id="myLocation" aria-label="Usar minha localização"><i class="fas fa-crosshairs"></i></button>
          </div>
        </div>
        <div class="error-message" id="mapError"></div>
      </div>
      <div class="form-group">
        <label for="suggestion">Sugestão de Solução (opcional)</label>
        <textarea class="form-control" id="suggestion" rows="2" placeholder="Sugira uma solução para o problema"></textarea>
        <div class="error-message" id="suggestionError"></div>
      </div>
      <div class="btn-container">
        <button class="btn next-step" id="submitBtn">Enviar</button>
        <button class="btn go-back" id="goBack3">Voltar</button>
      </div>
    </div>
  </main>

  <!-- Firebase SDK -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <!-- Bootstrap JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <!-- AOS Animation -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>

  <!-- Particles.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

  <!-- Leaflet JS -->
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- CryptoJS for SHA1 -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <script>
    // Form state
    let currentStep = 0;
    let formData = {
      title: '',
      category: 'Buraco',
      urgency: 'Média',
      description: '',
      suggestion: '',
      image: null,
      latitude: null,
      longitude: null,
      municipality: '',
      neighborhood: ''
    };
    let map, marker;

    // Municipalities and neighborhoods
    const municipalitiesAndNeighborhoods = {
      'Belas': ['Morro Bento', 'Benfica', 'Vila Estoril', 'Talatona', 'Kilamba', 'Barra do Kwanza', 'Quilamba'],
      'Cacuaco': ['Kikolo', 'Sequele', 'Mulenvos', 'Cacuaco Praia', 'Kiaxi Grande', '4 de Fevereiro'],
      'Cazenga': ['Hoji Ya Henda', '11 de Novembro', 'Kima Kienda', 'São Pedro', 'Tala Hady'],
      'Ícolo e Bengo': ['Catete', 'Bom Jesus', 'Caculo Cahango', 'Cassoneca'],
      'Luanda': ['Maianga', 'Ingombota', 'Maculusso', 'Sambizanga', 'Rangel'],
      'Quiçama': ['Quiçama', 'Cabo Ledo', 'Demba Chio', 'Kissama'],
      'Kilamba Kiaxi': ['Palanca', 'Golfe', 'Cassequel', 'Sapú', 'Camama'],
      'Talatona': ['Futungo de Belas', 'Camama', 'Vida Pacífica', 'Benfica'],
      'Viana': ['Estalagem', 'Zango', 'Viana Centro', 'Baía']
    };

    // Cloudinary configuration
    const cloudinaryConfig = {
      cloudName: 'dlfukiusa',
      apiKey: '438687859144979',
      apiSecret: 'Fpco6q6IczfTOh-Lv5r0t1C1tMk',
      uploadPreset: 'fixabairro',
      folder: 'fixa/Desconhecido'
    };

    // Categories and urgencies
    const categories = [
      { name: 'Buraco', icon: 'fa-exclamation-circle', color: '#f59e0b' },
      { name: 'Lixo', icon: 'fa-trash', color: '#22c55e' },
      { name: 'Iluminação', icon: 'fa-lightbulb', color: '#f59e0b' },
      { name: 'Água', icon: 'fa-tint', color: '#0ea5e9' },
      { name: 'Segurança', icon: 'fa-shield-alt', color: '#ef4444' },
      { name: 'Outros', icon: 'fa-ellipsis-h', color: '#9ca3af' }
    ];

    const urgencies = [
      { level: 'Baixa', icon: 'fa-tachometer-alt', color: '#22c55e' },
      { level: 'Média', icon: 'fa-exclamation-triangle', color: '#f59e0b' },
      { level: 'Alta', icon: 'fa-exclamation-circle', color: '#ef4444' }
    ];

    // Utility functions
    function showError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
      }
    }

    function hideError(elementId) {
      const errorElement = document.getElementById(elementId);
      if (errorElement) {
        errorElement.style.display = 'none';
      }
    }

    async function getResponsibleIdForMunicipality(firebase, municipality) {
      try {
        const querySnapshot = await firebase.firestore()
          .collection('usuarios')
          .where('municipality', '==', municipality)
          .where('isResponsible', '==', true)
          .limit(1)
          .get();
        
        if (!querySnapshot.empty) {
          return querySnapshot.docs[0].id;
        }
        console.log(`Nenhum responsável encontrado para o município: ${municipality}`);
        return null;
      } catch (error) {
        console.error("Erro ao buscar responsável:", error.message);
        return null;
      }
    }

    async function uploadToCloudinary(file, neighborhood) {
      const timestamp = Math.floor(Date.now() / 1000);
      const folder = neighborhood ? `fixa/${neighborhood}` : cloudinaryConfig.folder;
      const paramsToSign = {
        timestamp,
        upload_preset: cloudinaryConfig.uploadPreset,
        folder
      };

      const sortedParams = Object.keys(paramsToSign).sort().reduce((obj, key) => {
        obj[key] = paramsToSign[key];
        return obj;
      }, {});
      let signatureString = '';
      for (const [key, value] of Object.entries(sortedParams)) {
        if (key !== 'file' && key !== 'api_key') {
          signatureString += `${key}=${value}&`;
        }
      }
      signatureString = signatureString.slice(0, -1) + cloudinaryConfig.apiSecret;
      const signature = CryptoJS.SHA1(signatureString).toString();

      const formData = new FormData();
      formData.append('file', file);
      formData.append('api_key', cloudinaryConfig.apiKey);
      formData.append('timestamp', timestamp);
      formData.append('signature', signature);
      formData.append('upload_preset', cloudinaryConfig.uploadPreset);
      formData.append('folder', folder);

      const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`, {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`Falha no upload: ${response.status} - ${errorData.error.message}`);
      }

      const data = await response.json();
      return data.secure_url;
    }

    function initializeMap() {
      if (map) map.remove();
      map = L.map('formMap').setView([-8.838333, 13.234444], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(map);

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const { latitude, longitude } = position.coords;
            map.setView([latitude, longitude], 15);
            formData.latitude = latitude;
            formData.longitude = longitude;
            marker = L.marker([latitude, longitude], { draggable: true }).addTo(map);
            marker.on('dragend', () => {
              formData.latitude = marker.getLatLng().lat;
              formData.longitude = marker.getLatLng().lng;
            });
          },
          () => {
            marker = L.marker([-8.838333, 13.234444], { draggable: true }).addTo(map);
            formData.latitude = -8.838333;
            formData.longitude = 13.234444;
            marker.on('dragend', () => {
              formData.latitude = marker.getLatLng().lat;
              formData.longitude = marker.getLatLng().lng;
            });
          }
        );
      } else {
        marker = L.marker([-8.838333, 13.234444], { draggable: true }).addTo(map);
        formData.latitude = -8.838333;
        formData.longitude = 13.234444;
        marker.on('dragend', () => {
          formData.latitude = marker.getLatLng().lat;
          formData.longitude = marker.getLatLng().lng;
        });
      }

      map.on('click', (e) => {
        if (marker) {
          marker.setLatLng(e.latlng);
        } else {
          marker = L.marker(e.latlng, { draggable: true }).addTo(map);
        }
        formData.latitude = e.latlng.lat;
        formData.longitude = e.latlng.lng;
        marker.on('dragend', () => {
          formData.latitude = marker.getLatLng().lat;
          formData.longitude = marker.getLatLng().lng;
        });
      });
    }

    // Navigation functions
    function showStep(stepIndex) {
      document.querySelectorAll('.content').forEach((content, index) => {
        content.classList.toggle('active', index === stepIndex);
      });
      document.querySelectorAll('.steps li').forEach((step, index) => {
        step.classList.toggle('step-active', index === stepIndex);
      });
      currentStep = stepIndex;
      if (stepIndex === 2) {
        setTimeout(initializeMap, 0);
      }
    }

    // Initialize form
    function initializeForm() {
      // Populate municipalities
      const municipalitySelect = document.getElementById('municipality');
      Object.keys(municipalitiesAndNeighborhoods).forEach(mun => {
        const option = document.createElement('option');
        option.value = mun;
        option.textContent = mun;
        municipalitySelect.appendChild(option);
      });

      // Populate categories
      const categoryGrid = document.getElementById('categoryGrid');
      categoryGrid.innerHTML = categories.map(cat => `
        <div class="category-chip ${formData.category === cat.name ? 'selected' : ''}" data-category="${cat.name}">
          <i class="fas ${cat.icon}" style="color: ${cat.color}"></i>
          ${cat.name}
        </div>
      `).join('');

      // Populate urgencies
      const urgencyRadio = document.getElementById('urgencyRadio');
      urgencyRadio.innerHTML = urgencies.map(urg => `
        <input type="radio" name="urgency" id="urgency-${urg.level}" value="${urg.level}" ${formData.urgency === urg.level ? 'checked' : ''}>
        <label for="urgency-${urg.level}">
          <i class="fas ${urg.icon}" style="color: ${urg.color}"></i>
          ${urg.level}
        </label>
      `).join('');

      // Event listeners for Step 1
      document.getElementById('title').addEventListener('input', (e) => {
        formData.title = e.target.value.trim();
        hideError('titleError');
      });

      document.getElementById('municipality').addEventListener('change', (e) => {
        formData.municipality = e.target.value;
        formData.neighborhood = '';
        const neighborhoodSelect = document.getElementById('neighborhood');
        neighborhoodSelect.disabled = !formData.municipality;
        neighborhoodSelect.innerHTML = '<option value="">Selecione um bairro</option>';
        if (formData.municipality && municipalitiesAndNeighborhoods[formData.municipality]) {
          municipalitiesAndNeighborhoods[formData.municipality].forEach(nb => {
            const option = document.createElement('option');
            option.value = nb;
            option.textContent = nb;
            neighborhoodSelect.appendChild(option);
          });
        }
        hideError('municipalityError');
      });

      document.getElementById('neighborhood').addEventListener('change', (e) => {
        formData.neighborhood = e.target.value;
        hideError('neighborhoodError');
      });

      document.querySelectorAll('.category-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          document.querySelectorAll('.category-chip').forEach(c => c.classList.remove('selected'));
          chip.classList.add('selected');
          formData.category = chip.dataset.category;
          hideError('categoryError');
        });
      });

      document.querySelectorAll('input[name="urgency"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          formData.urgency = e.target.value;
          hideError('urgencyError');
        });
      });

      // Event listeners for Step 2
      document.getElementById('description').addEventListener('input', (e) => {
        formData.description = e.target.value.trim();
        hideError('descriptionError');
      });

      const imageUpload = document.getElementById('imageUpload');
      const imageInput = document.getElementById('image');
      imageUpload.addEventListener('click', () => imageInput.click());
      imageInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          if (!['image/jpeg', 'image/png'].includes(file.type)) {
            showError('imageError', 'Apenas imagens JPEG ou PNG são permitidas');
            return;
          }
          if (file.size > 5 * 1024 * 1024) {
            showError('imageError', 'A imagem deve ter no máximo 5MB');
            return;
          }
          formData.image = file;
          const reader = new FileReader();
          reader.onload = (e) => {
            const previewContainer = document.createElement('div');
            previewContainer.className = 'image-preview-container';
            previewContainer.id = 'imagePreviewContainer';
            previewContainer.style.display = 'block';
            previewContainer.innerHTML = `<img id="imagePreview" class="image-preview" src="${e.target.result}" alt="Prévia da imagem">`;
            imageUpload.innerHTML = '';
            imageUpload.appendChild(previewContainer);
          };
          reader.readAsDataURL(file);
          hideError('imageError');
        }
      });

      // Event listeners for Step 3
      document.getElementById('suggestion').addEventListener('input', (e) => {
        formData.suggestion = e.target.value.trim();
      });

      document.getElementById('zoomIn').addEventListener('click', () => {
        map.setZoom(map.getZoom() + 1);
      });

      document.getElementById('zoomOut').addEventListener('click', () => {
        map.setZoom(map.getZoom() - 1);
      });

      document.getElementById('myLocation').addEventListener('click', () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(position => {
            const { latitude, longitude } = position.coords;
            map.setView([latitude, longitude], 15);
            if (marker) {
              marker.setLatLng([latitude, longitude]);
            } else {
              marker = L.marker([latitude, longitude], { draggable: true }).addTo(map);
            }
            formData.latitude = latitude;
            formData.longitude = longitude;
          });
        }
      });

      // Navigation buttons
      document.getElementById('nextStep1').addEventListener('click', () => {
        let isValid = true;
        if (!formData.title) {
          showError('titleError', 'Por favor, insira um título');
          isValid = false;
        }
        if (!formData.municipality) {
          showError('municipalityError', 'Por favor, selecione um município');
          isValid = false;
        }
        if (!formData.neighborhood) {
          showError('neighborhoodError', 'Por favor, selecione um bairro');
          isValid = false;
        }
        if (!formData.category) {
          showError('categoryError', 'Por favor, selecione uma categoria');
          isValid = false;
        }
        if (!formData.urgency) {
          showError('urgencyError', 'Por favor, selecione o nível de urgência');
          isValid = false;
        }
        if (isValid) {
          showStep(1);
        }
      });

      document.getElementById('nextStep2').addEventListener('click', () => {
        let isValid = true;
        if (!formData.description) {
          showError('descriptionError', 'Por favor, insira uma descrição');
          isValid = false;
        }
        if (!formData.image) {
          showError('imageError', 'Por favor, adicione uma imagem');
          isValid = false;
        }
        if (isValid) {
          showStep(2);
        }
      });

      document.getElementById('goBack2').addEventListener('click', () => {
        showStep(0);
      });

      document.getElementById('goBack3').addEventListener('click', () => {
        showStep(1);
      });

      document.getElementById('submitBtn').addEventListener('click', async () => {
        if (!formData.latitude || !formData.longitude) {
          showError('mapError', 'Por favor, selecione uma localização');
          return;
        }

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Enviando <span class="spinner"></span>';

        try {
          const user = firebase.auth().currentUser;
          if (!user) throw new Error('Usuário não autenticado');

          const imageUrl = await uploadToCloudinary(formData.image, formData.neighborhood);
          const responsibleId = await getResponsibleIdForMunicipality(firebase, formData.municipality);

          const problemData = {
            usuarioId: user.uid,
            title: formData.title,
            category: formData.category,
            urgency: formData.urgency,
            description: formData.description,
            suggestion: formData.suggestion || '',
            imageUrl,
            location: {
              latitude: formData.latitude,
              longitude: formData.longitude
            },
            status: 'Aguardando',
            createdAt: Date.now(),
            neighborhood: formData.neighborhood,
            municipality: formData.municipality,
            responsibleId: responsibleId || null
          };

          await firebase.database().ref('problems').push(problemData);
          alert('Problema relatado com sucesso!');
          window.location.href = 'index.html';
        } catch (error) {
          console.error('Erro ao relatar problema:', error.message);
          showError('mapError', 'Erro ao relatar problema.');
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'Enviar';
        }
      });
    }

    // Firebase Auth Module
    const firebaseAuth = {
      logout: function(logoutBtn, logoutText, logoutSpinner) {
        firebase.auth().signOut().then(() => {
          window.location.href = 'login.html';
        }).catch(error => {
          console.error("Erro ao fazer logout:", error.message);
          logoutText.style.display = 'inline-block';
          logoutSpinner.remove();
          logoutBtn.disabled = false;
          alert('Erro ao fazer logout: ' + error.message);
        });
      }
    };

    // Initialize page
    window.addEventListener('load', () => {
      // Initialize AOS
      if (typeof AOS !== 'undefined') {
        AOS.init({
          duration: 800,
          easing: 'ease-in-out',
          once: true
        });
      } else {
        console.warn('AOS library not loaded');
      }

      // Initialize Particles.js
      if (typeof particlesJS !== 'undefined') {
        particlesJS('particles-js', {
          particles: {
            number: { value: 20, density: { enable: true, value_area: 1000 } },
            color: { value: ['#1e40af', '#22c55e', '#f59e0b'] },
            shape: { type: 'circle' },
            opacity: { value: 0.4, random: true },
            size: { value: 3, random: true },
            line_linked: { enable: false },
            move: { enable: true, speed: 0.8, direction: 'none', random: true }
          },
          interactivity: {
            detect_on: 'canvas',
            events: { onhover: { enable: true, mode: 'repulse' }, onclick: { enable: true, mode: 'push' } },
            modes: { repulse: { distance: 100 }, push: { particles_nb: 4 } }
          },
          retina_detect: true
        });
      } else {
        console.warn('Particles.js library not loaded');
      }

      // Initialize Firebase
      if (typeof firebase !== 'undefined') {
        const firebaseConfig = {
          apiKey: "AIzaSyDVtY6ML3j-qrIsAprIJPB5xFFCbcf4UQw",
          authDomain: "facilita-479b3.firebaseapp.com",
          projectId: "facilita-479b3",
          storageBucket: "facilita-479b3.appspot.com",
          messagingSenderId: "385676676886",
          appId: "1:385676676886:web:6976de7f3abc6c0da94a37",
          databaseURL: "https://facilita-479b3-default-rtdb.firebaseio.com/"
        };
        
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }

        firebase.auth().onAuthStateChanged(async user => {
          if (!user) {
            document.querySelector('.container').innerHTML = `
              <div class="error-message" style="display: block; margin: 20px;">Por favor, faça login para relatar um problema.</div>
            `;
            setTimeout(() => window.location.href = 'login.html', 2000);
            return;
          }

          try {
            const userDoc = await firebase.firestore().collection('usuarios').doc(user.uid).get();
            const userData = userDoc.exists ? userDoc.data() : { nome: user.displayName || "Usuário", email: user.email || "" };
            formData.municipality = userData.municipality || '';
            initializeForm();
          } catch (error) {
            console.error("Erro ao carregar dados:", error.message);
            document.querySelector('.container').innerHTML = `
              <div class="error-message" style="display: block; margin: 20px;">Erro ao carregar formulário. Verifique sua conexão.</div>
            `;
          }
        });
      } else {
        console.warn('Firebase SDK not loaded');
        document.querySelector('.container').innerHTML = `
          <div class="error-message" style="display: block; margin: 20px;">Erro ao carregar formulário. Verifique sua conexão.</div>
        `;
      }
    });
  </script>
</body>
</html>